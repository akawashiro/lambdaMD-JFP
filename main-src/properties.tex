% !TEX root = ../main.tex

\section{Properties of \LMD \label{sec:properties}}

\subsection{Properties of Typing}

In this subsection, we show the basic properties of \LMD: preservation, strong
normalization, confluence for full reduction, and progress for staged
reduction.

First, we start from the Weakening Lemma which we need in the proof of the Substitution Lemma.
We let $\mathcal{J}$ stand for the judgments \({K \iskind @A}\),
\({\tau::K@A}\), \({M:\tau@A}\), \({K \E K' @ A}\), \({\tau \E \tau' @ A}\),
and \({M \E M' : \tau @ A}\).  Substitutions \({\mathcal{J}[z \mapsto M]}\) and
\({\mathcal{J}[\alpha \mapsto A]}\) are defined in a straightforward manner.
We use these notations throughout this paper.
\AK{paper?}.

\begin{lemma}[Weakening]
    \label{lemma:Weakening}
    If \(\G \V \mathcal{J}@A\) and \(\G\) is a sub-sequence of \(\D\), then \(\D \V \mathcal{J}@A\).
\end{lemma}

% Substitution Lemma

The Substitution Lemma in \LMD{} is a little more complicated than usual
because there are eight judgment forms and two kinds of substitution.  The Term
Substitution Lemma states that term substitution $[z \mapsto M]$ preserves
derivability of judgments. The Stage Substitution Lemma states a similar
property for stage substitution $[\alpha\mapsto A]$.  

\begin{lemma}[Term Substitution]
    \label{lemma:TermSubstitution}
    If \({\G, z:\xi@B, \D \V \mathcal{J}}\) and \({\G\V N:\xi @B}\), then \({\G, (\D[z \mapsto N]) \V \mathcal{J}[z \mapsto N]}\).  Similarly, if \({\V \G, z:\xi@B, \D}\) and
    \( {\G\V N:\xi @B} \), then ${ \V \G, (\D[z \mapsto N]) }$.
\end{lemma}

\begin{lemma}[Stage Substitution]\
    \label{lemma:StageSubstitution}
    If $\G \V \mathcal{J}$, then $\G[\beta\mapsto B] \V \mathcal{J}[\beta\mapsto B]$.  Similarly, if $\V \G$, then $\V \G[\beta\mapsto B]$.
\end{lemma}

\begin{proof}
    By simultaneous induction on derivations.
\end{proof}

% Agreement

We prove agreement to use later in the completeness of the algorithmic typing.

\begin{lemma}[Agreement]\
    \label{lemma:Agreement}
    \begin{itemize}
        \item If \(\G\V \tau::K@A\), then \(\G\V K \iskind@A \).
        \item If \(\G\V M:\tau@A\), then \(\G\V \tau::*@A\).
        \item If \(\G\V K\E J@A\), then \(\G\V K @A\) and \(\G\V J @A\).
        \item If \(\G\V \tau\E \sigma :: K@A\), then \(\G\V \tau::K@A\) and \(\G\V \sigma::K@A\).
        \item If \(\G\V M\E N : \tau@A\), then \(\G\V M:\tau@A\) and \(\G\V N:\tau@A\).
    \end{itemize}
\end{lemma}
\begin{proof}
    By induction on the derivation tree.
\end{proof}


% Inversion Lemma

The following Inversion Lemma is needed to prove the main theorems.  As
usual~\cite{TAPL}, the Inversion Lemma enables us to infer the types of
subterms of a term from the shape of the term.

\begin{lemma}[Inversion]\ 
	\begin{itemize}
		\item If $\G \V (\lambda x:\sigma.M) : \rho$ then there are $\sigma'$ and $\tau'$ such that
		      $\rho = \Pi x:\sigma'.\tau'$, $\G \V \sigma \E \sigma'@A$ and $\G ,x:\sigma'@A\V M:\tau'@A$.
		\item If $\G \V \TB_\alpha M : \tau@A$ then 
		      there is $\sigma$ such that $\tau = \TW_\alpha \sigma$ and $\G \V M : \sigma@A$.
		  \item If $\G \V \Lambda\alpha.M : \tau$ then 
		  there is $\sigma$ such that $\sigma = \forall\alpha.\sigma$ and $\G \V M : \sigma@A$.% and $\alpha \notin \FTV(\G) \cup \FV(A)$.
	\end{itemize}
\end{lemma}

\begin{proof}
  Each item is strengthened by statements about type equivalence.
    For example, the first statement is augmented by
      If ${\G \V \rho \E (\Pi x:\sigma.\tau) : K @A}$, then there exist
      $\sigma'$ and $\tau'$ such that ${\rho = \Pi x:\sigma'.\tau'}$ and
      ${\G \V \sigma \E \sigma' : K @A}$ and
      ${\G, x:\sigma@A\V \tau \E \tau' : J @A}$.
  and its symmetric version. Then, they are proved simultaneously by induction
    on derivations. Similarly for the others.
\end{proof}

% Preservation

Thanks to Term/Stage Substitution and Inversion, we can prove Type
Preservation.

\begin{lemma}[Type and Equivalence Preservation]\
    \label{lemma:TypeAndEquivalencePreservationon}
    \begin{itemize}
    \item If \( \G \V M : \tau @ A \) and \( M \longrightarrow M' \), then \( \G \V M' : \tau @ A \).
    \item If \( \G \V M \E M' : \tau @ A \) and \( M \longrightarrow M'' \), then \( \G \V M'' \E M' : \tau @ A \).
    \end{itemize}
\end{lemma}

\begin{proof}
    First, there are three base cases for $M \longrightarrow M'$.  They are $M
    \longrightarrow_\beta M'$, $M \longrightarrow_\Lambda M'$, and $M
    \longrightarrow_\blacklozenge M'$.  For each case, we can use
    straightforward induction on derivations.
\end{proof}

\begin{theorem}[Type Preservation]\
    \label{theorem:TypePreservation}
    If \( \G \V M : \tau @ A \) and \( M \longrightarrow M' \), then \( \G \V M' : \tau @ A \).
\end{theorem}

\begin{proof} 
    This is a corollary of Lemma~\ref{lemma:TypeAndEquivalencePreservationon}.
\end{proof}

% Strong Normalization and how to prove it

Strong Normalization is also an important property, which guarantees that no
typed term has an infinite reduction sequence. To prove this, we translate \LMD
to LF~\cite{HarperHonsellPlotkin1993Framework} preserving \( \beta \)-reductions.

\begin{definition}[$\natural$ translation]\
    The $\natural$ translation is a translation from $\lambda^\text{MD}$ to \text{LF}.
    \begin{multicols}{2}
        \begin{itemize}
            \item Kind
                \begin{align*}
                    \natural(*) &= \operatorname{Type} & \\
                    \natural(\Pi x:\tau.K) &= \Pi x:\natural(\tau).\natural(K) &
                \end{align*}
            \item Term
                \begin{align*}
                    \natural(c) &= c & \\
                    \natural(x) &= x & \\
                    \natural(\lambda x:\tau.M) &= \lambda x:\natural(\tau).\natural(M) & \\
                    \natural(M\ N) &= \natural(M)\ \natural(N)& \\
                    \natural(\TB_\alpha M) &= \natural(M) & \\
                    \natural(\TBL_\alpha M) &= \natural(M)& \\
                    \natural(\Lambda\alpha.M) &= \natural(M)& \\
                    \natural(M\ B) &= \natural(M) &
                \end{align*}
            \item Type
            \begin{align*}
                \natural(X) &= X & \\
                \natural(\Pi x:\tau.\sigma) &= \Pi x:(\tau). \natural(\sigma) & \\
                \natural(\tau\ M) &= \natural(\tau) \natural(M) & \\
                \natural(\TW_\alpha \tau) &= \natural(\tau) & \\
                \natural(\forall \alpha.\tau) &= \natural(\tau) &
            \end{align*}
        \item Context
            \begin{align*}
                \natural(\phi) &= \phi & \\
                \natural(\G, x:\tau@A) &= \natural(\G), \natural(x):\natural(\tau) & \\
            \end{align*}
        \item Signature
            \begin{align*}
                \natural(\phi) &= \phi & \\
                \natural(\Sigma, c:\tau) &= \natural(\Sigma),\natural(c):\natural(\tau) & \\
                \natural(\Sigma, X:K) &= \natural(\Sigma), \natural(X):\natural(K) &
            \end{align*}
    \end{itemize}
    \end{multicols}
\end{definition}

We show \( \natural \) translation preserves typing and equivalence of \LMD.

\begin{lemma}[Substitution and $\natural$]\
    \label{lemma:SubstitutionAndNatural}
    If \( \G, x:\sigma \D \V M:\tau@A \) and \( \G \V N:\sigma@A\) in \LMD
    then $\natural(M[x \mapsto N])$ = $\natural(M)[x\mapsto\natural(N)]$
\end{lemma}

\begin{proof}
    By induction on the type derivation tree of $\G, x:\sigma \D \V M:\tau@A$.
\end{proof}

\begin{lemma}[Preservation of Judgements in $\natural$]\
    \label{lemma:PreservationOfJudgementsInNatural}
    There are following relations between judgments in \LMD and \text{LF}.
    \begin{itemize}
        \item If \( \vdash \Sigma \) then \( \natural(\Sigma)\ \operatorname{sig} \).
        \item If \( \V \Gamma \) then \( \vdash_{\natural(\Sigma)} \natural(\Gamma) \).
        \item If \( \G \V K \iskind@A \) then \( \natural(\G) \vdash_{\natural(\Sigma)} \natural(K) \).
        \item If \( \G \V \tau : K @ A \) then \( \natural(\G) \vdash_{\natural(\Sigma)} \natural(\tau) : \natural(K) \).
        \item If \( \G \V M : \tau @ A \) then \( \natural(\G) \vdash_{\natural(\Sigma)} \natural(M) : \natural(\tau) \).
        \item If \( \G \V K \E K' @ A \) then \( \natural(\G) \vdash_{\natural(\Sigma)} \natural(K) \E \natural(K') \), \( \natural(\G) \vdash_{\natural(\Sigma)} \natural(K) \) and \( \natural(\G) \vdash_{\natural(\Sigma)} \natural(K') \).
        \item If \( \G \V \tau \E \tau' : K @ A \) then \( \natural(\G) \vdash_{\natural(\Sigma)} \natural(\tau) \E \natural(\tau') \), \( \natural(\G) \vdash_{\natural(\Sigma)} \natural(\tau) : \natural(K) \) and \( \natural(\G) \vdash_{\natural(\Sigma)} \natural(\tau') : \natural(K) \).
        \item If \({ \G \V M \E M' : \tau @ A }\) then \({ \natural(\G) \vdash_{\natural(\Sigma)} \natural(M) \E \natural(M') }\), \({ \natural(\G) \vdash_{\natural(\Sigma)} \natural(M) : \natural(\tau) }\) and \({ \natural(\G) \vdash_{\natural(\Sigma)} \natural(M') : \natural(\tau) }\).
    \end{itemize}
\end{lemma}

\begin{proof}
    We can prove using induction on the type derivation tree.
    We show the case of \TApp{} and \TConv{} as examples.
    Other cases are easy.
    \begin{rneqncase}{\TApp{}}{
            \G \V M : (\Pi(x:\sigma).\tau) @ A \text{ and } \G \V N :\sigma @A
        }
        From the induction hypothesis, we have \({ \natural(\G)
        \vdash_{\natural(\sigma)} \natural(M) : \Pi
        x:\natural(\sigma).\natural(\tau) }\) and \({ \natural(\G)
        \vdash_{\natural(\sigma)} \natural(N) : \natural(\sigma) }\).  Using
        \textsc{B-APP-OBJ} rule in LF, we get \\ \({ \natural(\G)
        \vdash_{\natural(\sigma)} \natural(M)\ \natural(N) : \natural(\tau)[x
        \mapsto \natural(N)] }\).  Because \({ \natural(M)\ \natural(N) =
        \natural(M\ N) }\) from the definition of $\natural$ and \({ \natural(\tau)[x \mapsto \natural(N)] = \natural(\tau[x \mapsto N]) }\) from Lemma~\ref{lemma:SubstitutionAndNatural}, \\
        ${ \natural(\G) \vdash_{\natural(\sigma)} \natural(M\ N) :
        \natural(\tau[x \mapsto N]) }$ in LF.
    \end{rneqncase}
    \begin{rneqncase}{\TConv{}}{
            \G\V M:\tau@A \text{ and } \G\V \tau \E \tau' : K @A
        }
        By the induction hypothesis, \( \natural(\G) \vdash_{\natural(\Sigma)}
        \natural(M):\natural(\tau) \), \( \natural(\G)
        \vdash_{\natural(\Sigma)} \natural(\tau) \E \natural(\tau') \), \(
        \natural(\G) \vdash_{\natural(\Sigma)} \natural(\tau) : \natural(K) \)
        and \( \natural(\G) \vdash_{\natural(\Sigma)} \natural(\tau') :
        \natural(K) \). From Lemma~\ref{lemma:Agreement}, \( K \) is \( * \).
        Therefore, \( \natural(\G) \vdash_{\natural(\Sigma)} \natural(\tau') :
        \text{Type} \). Now, we can use \textsc{B-CONV-OBJ} and get \(
        \natural(\G) \vdash_{\natural(\Sigma)} \natural(M) : \natural(\tau')
        \).
    \end{rneqncase}
\end{proof}

\begin{lemma}[Preservation of $\beta$-Reduction in $\natural$]
    \label{lemma:PreservationOfBetaReductionInNatural}
    If $\G \V M:\tau@A$ and $M \longrightarrow_\beta N$ in $\lambda^{\text{MD}}$
    then $\natural(M) \longrightarrow_\beta^+ \natural(N)$.
\end{lemma}

\begin{proof}
    By induction on the derivation of $\beta$-reduction of \LMD.
    We show only the main case.
    \newcommand{\R}{\longrightarrow_{\beta}}
    \begin{rneqncase}{$(\lambda x:\tau.M)\ N \R M[x \mapsto N]$}{}
        From the definition of $\natural$, $\natural((\lambda x:\tau.M)\ N)$ =
        $\lambda x:\natural(\tau).\natural(M)\ \natural(N)$.  Because $\lambda
        x:\natural(\tau).\natural(M)\ \natural(N)$ is a typed term in LF by
        Lemma~\ref{lemma:PreservationOfJudgementsInNatural}, we can perform
        $\beta$-reduction from it.  As a result of the reduction, we get
        $\natural(M)[x\mapsto\natural(N)]$.  From
        \ref{lemma:SubstitutionAndNatural}, $\natural(M[x \mapsto N])$ =
        $\natural(M)[x\mapsto\natural(N)]$.
    \end{rneqncase}
\end{proof}

\begin{lemma}[Preservation of $\Lambda$-Reduction in $\natural$]
    \label{lemma:PreservationOfLambdaReductionInNatural}
    If $\G \V M:\tau@A$ and $M \longrightarrow_\Lambda N$ in $\lambda^{\text{MD}}$
    then $\natural(M)$ =  $\natural(N)$.
\end{lemma}

\begin{proof}
    We prove by induction on the derivation of $\Lambda$-reduction of \LMD.
    We show only the main case.
    \begin{rneqncase}{\( (\Lambda\alpha.M)\ A \longrightarrow_\Lambda M[\alpha\mapsto A] \)}{}
            By the definition of $\natural$, \(\natural((\Lambda\alpha.M)\ A) =
            \natural(M)\).  Because \(\natural(M)\) does not contain
            \(\alpha\), \(\natural(M[\alpha\mapsto A]) = \natural(M)\).
    \end{rneqncase}
\end{proof}

\begin{lemma}[Preservation of $\blacklozenge$-Reduction in $\natural$]
    \label{lemma:PreservationOfBlacklozengeReductionInNatural}
    If $\G \V M:\tau@A$ and ${M \longrightarrow_\blacklozenge N}$ in $\lambda^{\text{MD}}$
    then $\natural(M)$ =  $\natural(N)$.
\end{lemma}

\begin{proof}
    We prove by induction on the derivation of $\blacklozenge$-reduction of
    \LMD.  We show only the main case.
    \begin{rneqncase}{ \( \TBL_\alpha \TB_\alpha M \longrightarrow_\blacklozenge M \) }{}
        By the definition of $\natural$, \(\natural(\TBL_\alpha \TB_\alpha M) =
        \natural(M)\).
    \end{rneqncase}
\end{proof}

To prove Strong Normalization, we prove that there is no infinite sequence composed of \( \Lambda \) and \( \blacklozenge \)-reductions, first.

\begin{lemma}[Strong Normalization without \( \beta \)-reduction]
    \label{lemma:StrongNormalizationWithoutBetaReduction}
    If \( \G\V M_1:\tau@A \) then there is no infinite sequence of terms $\{M_i\}_{i\ge1}$ which satisfies $M_i \longrightarrow_\Lambda M_{i+1}$ or $M_i \longrightarrow_\blacklozenge M_{i+1}$ for $i\ge 1$.
\end{lemma}

\begin{proof}
    % Prove by lexicographical order.
    We write the number of \( \Lambda \) in term \( M \) as \( \#\Lambda_M \) and the number of \( \TB \) in term \( M \) as \( \#\TB_M \). For \( i \ge 1 \), the pair \( ( \sharp \Lambda_{M_i}, \sharp \TB_{M_i} ) \) is strictly greater than the pair \( (\#\Lambda_{M_{i+1}}, \#\TB_{M_{i+1}}) \) in lexicographical order because \( \Lambda \)-reduction reduces the number of \( \Lambda \) by one and \( \blacklozenge \)-reduction reduces the number of \( \TB \) by one preserving the number of \( \Lambda \). Now, the lemma follows from well-foundedness of pairs of natural number.

    % Prove not by lexicographical order
    % Prove by contradiction. If there is a such infinite sequence \( \{M_i\}_{i\ge1} \), there is another infinite sequence \( \{ N_i \}_{ i \ge 1 } \) which satisfies $N_i \longrightarrow_\blacklozenge N_{i+1}$ for \( i \ge 1 \). This is because both \( \Lambda \) and \( \blacklozenge \)-reductions reduce or preserve the number of \( \Lambda \) in the term, therefore we can perform \( \Lambda \)-reduction only a finite number of times. However, \( \blacklozenge \)-reduction always reduces the size of the term, thus we can perform \( \blacklozenge \)-reduction only finite a finite number of times also. 
\end{proof}

Then, we can prove Strong Normalization of \LMD.

\begin{theorem}[Strong Normalization]
    \label{theorem:StrongNormalization}
    If \( \G\V M_1:\tau@A \) then there is no infinite sequence of terms $\{M_i\}_{i\ge1}$ which satisfies $M_i \longrightarrow M_{i+1}$ for $i\ge 1$.
\end{theorem}

\begin{proof}

    If there is an infinite reduction sequence in \LMD then there are infinite \( \beta \)-reductions in the sequence. If there are only finite \( \beta \)-reductions in the sequence, we can construct another infinite reduction sequence which is composed only of \( \Lambda \)-reduction and \( \blacklozenge \)-reduction. However, it contradicts Lemma~\ref{lemma:StrongNormalizationWithoutBetaReduction}.
    
    Then, we show Strong Normalization by proof by contradiction. 
    
    We assume that there is an infinite reduction sequence \( \{ M_i \} \) of \LMD and \( \G\V M_1:\tau@A \). Thanks to discussion above, we can assume it contains infinite \( \beta \)-reductions. From \( \{ M_i \} \), we can construct another infinite reduction sequence \( \{ \natural(M_i) \} \). From Lemma~\ref{lemma:PreservationOfBetaReductionInNatural}, \ref{lemma:PreservationOfLambdaReductionInNatural}, \ref{lemma:PreservationOfBlacklozengeReductionInNatural}, there are infinite \( \beta \)-reductions in \( \{ \natural(M_i) \} \).
    
    However, \( \natural(\G) \vdash_{\natural(\Sigma)} \natural(M_1):\natural(\tau) \) from Lemma~\ref{lemma:PreservationOfJudgementsInNatural} therefore the existence of \( \{ \natural(M_i) \} \) contradicts Strong Normalization of LF.
\end{proof}

Confluence is a property that any reduction sequences from one typed term
converge.  Since we have proved Strong Normalization, we can use Newman's
Lemma~\cite{BaaderTobias1998TermRewriting} to prove Confluence.

\begin{theorem}[Confluence]
    \label{theorem:confluence}
	For any term $M$, if $M \longrightarrow^* M'$ and $M \longrightarrow^* M''$ then
	there exists $M'''$ that satisfies $M' \longrightarrow^* M'''$ and $M'' \longrightarrow^* M'''$.
\end{theorem}

\begin{proof}
  We can easily show Weak Church-Rosser. Use Newman's Lemma.
	% Because we proved Strong Normalization of \LMD, 
	% we can use Newman's lemma to prove Confluence of \LMD.
	% Then, what we must show is Weak Church-Rosser Property now.
	% When we consider two different redexes in a \LMD term, they can only be disjoint, or one is a part of the other.
	% In short, they are never overlapped each other.
	% So, we can reduce one of them after we reduce another.
\end{proof}

Now, we turn our attention to staged semantics.  First, the staged
reduction relation is a subrelation of full reduction, so Subject
Reduction holds also for the staged reduction.

\begin{lemma}[Staged Reduction and Normal Reduction]
  If $M \longrightarrow_s M'$, then $M \longrightarrow M'$.
\end{lemma}
\begin{proof}
    Easy from the definition of \( M \longrightarrow_s M' \).
\end{proof}

The following theorem Unique Decomposition ensures that every typed
term is either a value or can be uniquely decomposed to an evaluation
context and a redex, ensuring that a well-typed term is not
immediately stuck and the staged semantics is deterministic.

\begin{theorem}[Unique Decomposition]
  If $\G$ does not have any variable declared at stage $\varepsilon$ 
  and $\G \V M : \tau @ A$, then either
  \begin{enumerate}
  \item $ M \in V^A$, or
  \item $M$ can be uniquely decomposed into an evaluation context and a redex, that is, there uniquely exist $B, E^A_B$, and $R^B$ such that $M = E^A_B[R^B]$.
  \end{enumerate}
\end{theorem}

\begin{proof}
  By straightforward induction on typing derivations.
\end{proof}

The type environment $\G$ of a statement usually must be empty; in other
words, the term must be closed. The condition is relaxed here because
variables at stages higher than \(\varepsilon\) are considered symbols. In
fact, this relaxation is required for proof by induction to work.

Progress is a corollary of Unique Decomposition.

\begin{theorem}[Progress]
	If $\G$ does not have any variable declared at stage $\varepsilon$ and $\G \V M : \tau  @ A$, then
	$ M \in V^A $ or there exists $M'$ such that $M \longrightarrow_s M'$.
\end{theorem}

\subsection{Properties of Algorithmic Typing}

In this subsection, we prove the properties of algorithmic typing of \LMD. The
main purpose of this subsection is proving the completeness and soundness of
algorithmic typing, which gives the equivalence with the original typing. We
start by proving the properties of algorithmic reduction because it is used to
define term equivalence in \QAANF. \ANF is a function which returns normal form
of a term in algorithmic reduction and \( \E_\alpha \) means \( \alpha \)
equivalence.

\begin{center}
    \infrule[\QAANF]{ \ANF(M) \E_\alpha \ANF(N) }{\G \AV M \E N@A}
\end{center}

First, we prove the uniqueness of \( \ANF(M) \) for all typed term \( M \)
using Strong Normalization and Confluence of algorithmic reduction.
Fortunately, we can prove these two properties similar to the original
reduction.

\begin{lemma}[Strong Normalization of Algorithmic Reduction]
    \label{lemma:StrongNormalizationofAlgorithmicReduction}
    If \( \G \AVS M :\tau @ A\), there is no infinite sequence of \( \RA \) reductions from \( M \).
\end{lemma}

\begin{proof}
    Proved by using \( \natural \) function.
\end{proof}

\begin{lemma}[Confluence of Algorithmic Reduction]
    \label{lemma:ConfluenceofAlgorithmicReduction}
    If \({ \G \AVS M :\tau @ A }\), \\ \({ M \RA^* M' }\) and \({ M \RA^* M'' }\)
    then there is a \( M''' \) such that \({ M' \RA^* M''' }\) and \({ M'' \RA^* M''' }\).
\end{lemma}

\begin{proof}
    By argument similar that in Thorem \ref{theorem:confluence} 
\end{proof}

\begin{lemma}[Uniqueness of Algorithmic Reduction Normal Form]
    \label{lemma:UniquenessOfANF}
    If \\ \({ \G \AVS M : \tau @ A }\) then there is the unique normal form of \( M \), \( \ANF(M) \).
\end{lemma}

\begin{proof}
    Immediate from Lemma \ref{lemma:StrongNormalizationofAlgorithmicReduction} and \ref{lemma:ConfluenceofAlgorithmicReduction}.
\end{proof}

Then, we prove the relationship between one step algorithmic reduction and substitutions.

\begin{lemma}[Algorithmic Reduction and Term Substitution]
    \label{lemma:AlgorithmicReductionAndTermSubstitution}
    If \\ \( \G, z:\xi@B, \D \AVS M : \tau @ A \), \( \G \AVS P : \xi @ B \) and \( M \RA M' \) then \\
    \( \ANF(M[z\mapsto P]) \E_\alpha \ANF(M'[z\mapsto P]) \).
\end{lemma}

\begin{proof}
    By induction on the derivation of \( M \RA M' \).
    \begin{rneqncase}{\textsc{A-\%}}{\%M \RA M \text{ and } \text{FV}(M)=\emptyset}
        From \( \text{FV}(M)=\emptyset \), \( z \notin \text{FV}(M) \) and \( z \notin \text{FV}(M') \).
        Then \( \ANF(M) \E_\alpha \ANF(M') \) is clear.
    \end{rneqncase}

    \begin{rneqncase}{\textsc{A-$\beta$}}{(\lambda x:\tau.M)\ N \RA M[x\mapsto N]}
        \begin{align*}
            & \ANF(((\lambda x:\tau.M)\ N)[z \mapsto P]) \\
            & = \ANF((\lambda x:\tau.M[z \mapsto P])\ N[z \mapsto P]) \\
            & = \ANF(M[z \mapsto P][x \mapsto N[z \mapsto P]]) & (\text{From Lemma } \ref{lemma:UniquenessOfANF}) \\
            & = \ANF(M[x \mapsto N][z \mapsto P]) \\
            & = \ANF(M'[z \mapsto P])
        \end{align*}
    \end{rneqncase}
\end{proof}

\begin{lemma}[Algorithmic Reduction and Stage Substitution]
    \label{lemma:AlgorithmicReductionAndStageSubstitution}
    If \( \G \AVS M : \tau @ A \) and \( M \RA M' \) then
    \( \ANF(M[\alpha \mapsto B]) \E_\alpha \ANF(M'[\alpha \mapsto B]) \).
\end{lemma}

\begin{proof}
    By induction on the derivation of \( M \RA M' \).
\end{proof}

Next, we prove that we can derive the same term in two different ways. On the
one hand, we may calculate the algorithmic normal form after the substitution.
On the other hand, we may calculate the algorithmic normal form after the
substitution for the algorithmic normal form. This property (state formally in
Lemma \ref{lemma:AlgorithmicNomalFormAndTermSubstitution}) is crucial for Term
Substitution Lemma of Algorithmic Judgement and Stage Substitution Lemma of
Algorithmic Judgement (Lemma
\ref{lemma:TermSubstitutionLemmaOfAlgorithmicJudgement} and Lemma
\ref{lemma:StageSubstitutionLemmaofAlgorithmicJudgement}). In \cite{benjamin2005attapldependent},
they use weak head normal form, but here we use normal form because we couldn't
prove this lemma for weak head normal form.

\begin{lemma}[Algorithmic Normal Form and Term Substitution]
    \label{lemma:AlgorithmicNomalFormAndTermSubstitution}
    If \\ \( \G, z:\xi@B, \D \AVS M : \tau @ A \) and \( \G \AVS P : \xi @ B \) then \\
    \({ \ANF(M[z\mapsto P]) \E_\alpha \ANF(\ANF(M)[z\mapsto P]) }\).
\end{lemma}

\begin{proof}
    Prove by induction on the length \( n \) of reduction from \( M \) to \( \ANF(M) \).
    \begin{rneqncase}{$n$ = 0}{M = \ANF(M) }
        It is immediate.
    \end{rneqncase}
    \begin{rneqncase}{$n$ = 1}{M \RA M' \text{ and } \ANF(M) = M' }
        From Lemma \ref{lemma:AlgorithmicReductionAndTermSubstitution}.
    \end{rneqncase}
    \begin{rneqncase}{$n$ > 1}{M \RA^* M' \text{ and } M' \RA^* M'' \text{ and } \ANF(M) = M'' }
        From the induction hypothesis, \( \ANF(M[z\mapsto P]) \E_\alpha \ANF(M'[z\mapsto P]) \).
        From Lemma \ref{lemma:AlgorithmicReductionAndTermSubstitution}, \( \ANF(M'[z\mapsto P]) \E_\alpha \ANF(M''[z\mapsto P]) \).
        Then from the transitivity of \( \E_\alpha \), \( \ANF(M[z\mapsto P]) \E_\alpha \ANF(\ANF(M)[z\mapsto P]) \).
    \end{rneqncase}
\end{proof}

\begin{lemma}[Algorithmic Normal Form and Stage Substitution]
    \label{lemma:AlgorithmicNomalFormAndStageSubstitution}
    If \\ \( \G \AVS M : \tau @ A \) then
    \( \ANF(M[\alpha \mapsto B]) \E_\alpha \ANF(\ANF(M)[\alpha \mapsto A]) \)
\end{lemma}

\begin{proof}
    Same as Lemma \ref{lemma:AlgorithmicNomalFormAndTermSubstitution} using
    Lemma \ref{lemma:AlgorithmicReductionAndStageSubstitution} instead of Lemma
    \ref{lemma:AlgorithmicReductionAndTermSubstitution}.
\end{proof}

Thanks to Lemma \ref{lemma:AlgorithmicNomalFormAndTermSubstitution} and Lemma
\ref{lemma:AlgorithmicNomalFormAndStageSubstitution}, we can prove two
substitution lemmas.

\begin{lemma}[Term Substitution Lemma of Algorithmic Judgement]
    \label{lemma:TermSubstitutionLemmaOfAlgorithmicJudgement}
    If $\G, z:\xi@B, \D \AVS \mathcal{J}$ and $\G\AVS P:\xi @B$ then $\G, \D[z \mapsto P] \AVS \mathcal{J}[z \mapsto P]$.
\end{lemma}

\begin{proof}
    By induction on the derivation of \( \G, z:\xi@B, \D \AVS \mathcal{J}
    \). Most cases are the same with Lemma \ref{lemma:TermSubstitution}. We show
    only different cases.

    \begin{rneqncase}{\textsc{QA-ANF}}{
            \G, z:\xi @ B, \D \AVS M \E N @ A \\
            \text{ is derived from }
            \ANF(M) \E_\alpha \ANF(N)
        }
    \end{rneqncase}
    \( \ANF(\ANF(M)[z \mapsto P]) \E_\alpha \ANF(\ANF(N)[z \mapsto P]) \) is obvious from \( \ANF(M) \E_\alpha \ANF(N) \).
    From Lemma \ref{lemma:AlgorithmicNomalFormAndTermSubstitution}, \( \ANF(M[z \mapsto P]) \E_\alpha \ANF(N[z \mapsto P]) \).
    Then \( \G, \D[z \mapsto P] \AVS M[z \mapsto P] \E N[z \mapsto P] @ A \).
\end{proof}

\begin{lemma}[Stage Substitution Lemma of Algorithmic Judgement]
    \label{lemma:StageSubstitutionLemmaofAlgorithmicJudgement}
    If $\G \AVS \mathcal{J}$ then $\G[\alpha \mapsto B] \AVS \mathcal{J}[\alpha \mapsto B]$.
\end{lemma}

\begin{proof}
    Same as Lemma \ref{lemma:TermSubstitutionLemmaOfAlgorithmicJudgement} using
    Lemma \ref{lemma:AlgorithmicNomalFormAndStageSubstitution} instead of Lemma
    \ref{lemma:AlgorithmicNomalFormAndTermSubstitution}.
\end{proof}

Lemma \ref{lemma:TermSubstitutionLemmaOfAlgorithmicJudgement} and
\ref{lemma:StageSubstitutionLemmaofAlgorithmicJudgement} enable to prove type
preservation of algorithmic reduction.

\begin{lemma}[Type Preservation of Algorithmic Reduction]
    \label{lemma:TypePreservationofAlgorithmicReduction}
    If \( \G \V M:\tau @A \) and \( M \RA M' \) then \( \G \V M' : \tau @ A \).
\end{lemma}

\begin{proof}
    Similar to Theorem \ref{theorem:TypePreservation}, we prove type and
    equivalence preservation lemma and use them. The different case is
    \textsc{A-\%}.  If \( \G \V \%_\alpha M : \tau @ A \), \( \%_\alpha M \RA M
    \) and \( \text{FV}(\%_\alpha M) = \emptyset \), \( M \) is a closed term.
    So \( \G \V M : \tau @ A \).
\end{proof}

\begin{lemma}[Algorithmic Type Preservation of Algorithmic Reduction]
    \label{lemma:AlgorithmicTypePreservationofAlgorithmicReduction}
    If \( \G \AVS M:\tau @A \) and \( M \RA M' \) then \( \G \AVS M' : \tau @ A \).
\end{lemma}

\begin{proof}
    Similar to Theorem \ref{theorem:TypePreservation}. In the case of
    \textsc{A-$\beta$} and \textsc{A-$\Lambda$} we can prove it by Lemma
    \ref{lemma:TermSubstitutionLemmaOfAlgorithmicJudgement} and
    \ref{lemma:StageSubstitutionLemmaofAlgorithmicJudgement}.
\end{proof}

\begin{lemma}[Algorithmic Reduction and Term Equivalence]
    \label{lemma:AlgorithmicReductionandTermEquivalence}
    If \( \G \V M : \tau @ A \) and \( M \RA M' \) then \( \G \V M \E M' : \tau @ A \).
\end{lemma}

\begin{proof}
    By case analysis on \( M \RA M' \).
    \begin{rneqncase}{\textsc{A-\%}}{\%_\alpha M \RA M \text{ and } \emptyset = \text{FV}(\%_\alpha M)}
        Now, we can assume \( \G \V \%_\alpha M : \tau @ A\alpha \) and \( \G
        \V M : \tau @ A \).  We prove \( \G \V M : \tau @ A\alpha \) by
        replacing all appearances of \( A \) with \( A\alpha \) in the
        derivation of \( \G \V M : \tau @ A \). Then, we can prove \( \G \V \%_\alpha M \E M @ A\alpha \) using \TCsp.
    \end{rneqncase}
\end{proof}

Now, we can say term \( M \) and \( \ANF(M) \) are equivalent.

\begin{lemma}[ANF and Term Equivalence]
    \label{lemma:ANFandTermEquivalence}
    If \( \G \V M : \tau @ A \) then \\ \({ \G \V M \E \ANF(M) : \tau @ A }\).
\end{lemma}
\begin{proof}
    Corollary of Lemma \ref{lemma:TypePreservationofAlgorithmicReduction} and
    \ref{lemma:AlgorithmicReductionandTermEquivalence}.
\end{proof}

Finally, we prove the soundness of algorithmic typing. It means that if a term
is typed in algorithmic typing then the term is also typed in the original
typing.  Because algorithmic typing is defined mutually involving other
algorithmic judgments, we use simultaneous induction for proof.

\begin{theorem}[Soundness of Algorithmic Typing]
    \label{theorem:SoundnessOfAlgorithmicTyping}
    If a term is typed in algorithmic rules then the term is typed in normal rules, too.
    \begin{itemize}
        \item If \(\G\AVS K \iskind @ A \) then \(\G\V K \iskind @A \).
        \item If \(\G\AVS \tau :: K @ A \) then \(\G\V \tau ::K  @ A \).
        \item If \(\G\AVS M:\tau @ A \) then \(\G\V M:\tau @ A \).
        \item If \(\G\AVS K,K' @ A\) and \(\G\AVS K\E K' @ A \) then \(\G\V K\E K' @ A \).
        \item If \(\G\AVS \tau,\tau' :: K @ A \) and \(\G\AVS \tau \E \tau' @ A \) then \(\G\V \tau \E \tau' :: K @ A \).
        \item If \(\G\AVS M,M' :: \tau @ A \) and \(\G\AVS M\E M' @ A \) then \(\G\V M\E M' :: \tau @ A \).
    \end{itemize}
\end{theorem}

\begin{proof}
    We can prove using induction on the derivation tree.
    \begin{rneqncase}{\KAApp{}}{
            \G\AVS \sigma\ M::K[x\mapsto M]@A \\
            \text{ is derived from } 
            \G\AVS \sigma:: (\Pi x:\tau.K)@A \text{ , }
            \G\AVS M:\tau'@A \text{ , } \\
            \G\AVS\tau'::*@A \text{ and } 
            \G\AVS \tau \E \tau' @ A.
        }
        Considering the derivation of \( \G\AVS \sigma:: (\Pi x:\tau.K)@A \), \( \G \AVS \tau::* \).
        Using the induction hypothesis on \( \G \V \tau, \tau'::* @ A \) and \( \G\AVS \tau \E \tau' @ A \),
        we get \( \G\V \tau \E \tau' :: * @ A \).

        From the induction hypothesis, \( \G\V \sigma:: (\Pi x:\tau.K)@A \) and \( \G\V M:\tau'@A \).
        \TConv and \KApp guide to \( \G\V \sigma\ M::K[x\mapsto M]@A \).

    \end{rneqncase}
    \begin{rneqncase}{\TAApp}{
            \G\AVS M\ N : \tau[x\mapsto N]@A \\
            \text{ is derived from } 
            \G\AVS M:(\Pi (x:\sigma).\tau) \text{ , }
            \G\AVS N:\sigma'@A \text{ , } \\
            \G\AVS \sigma'::*@A \text{ and }
            \G\AVS \sigma\E\sigma' @A
        }
        Just same as \KApp case, \( \G\V \sigma\E\sigma' :: * @A \).
        From the induction hypothesis, \( \G\V M:(\Pi (x:\sigma).\tau) @ A\) and \( \G\V N:\sigma'@A \).
        Then, \( \G\V M\ N : \tau[x\mapsto N]@A \) from \TConv and \TApp.
    \end{rneqncase}
    \begin{rneqncase}{\textsc{QA-ANF}}{
            \G \AV M \E N@A \\
            \text{ is derived from } 
            \G \AV \ANF(M) \E_\alpha \ANF(N) @A.
        }
        Apply the induction hypothesis on \( \G \AVS M, N : \tau @ A \), we get \( \G \V M, N : \tau @ A \).
        Apply Lemma \ref{lemma:TypePreservationofAlgorithmicReduction} to \( \G \V M, N : \tau @ A \), \( \G \V \ANF(M), \ANF(N) : \tau @ A \).
        Apply Corollary \ref{lemma:ANFandTermEquivalence} to \( \G \V \ANF(M), \ANF(N) : \tau @ A \), \( \G \V M \E \ANF(M) : \tau @ A \) and \( \G \V N \E \ANF(N) : \tau @ A \).

        Apply Lemma \ref{lemma:AlgorithmicTypePreservationofAlgorithmicReduction} to \( \G \V M, N : \tau @ A \), \( \G \AVS \ANF(M), \ANF(N) : \tau @ A \).
        \( \G \V \ANF(M) \E \ANF(N) : \tau @ A \) from using the induction hypothesis on \( \G \AVS \ANF(M), \ANF(N) : \tau @ A \) and \( \G \AV \ANF(M) \E_\alpha \ANF(N) @A \).

        Apply \QTrans to \( \G \V \ANF(M) \E \ANF(N) : \tau @ A \) and \\ \({ \G \V M \E \ANF(M) : \tau @ A }\) and \( \G \V N \E \ANF(N) : \tau @ A \), \( \G \V M \E N : \tau @ A \)
    \end{rneqncase}
\end{proof}

The next theorem is the completeness of algorithmic typing. First, we prove
symmetricity, reflexivity and transitivity of algorithmic typing, which are
indispensable for the proof.

\begin{lemma}[Symmetricity in Algorithmic Equivalence]
    The algorithmic equivalence relationship is symmetrical.
    \label{lemma:SymmetricityinAlgorithmicEquivalence}
    \begin{itemize}
        \item If \( \G \AVS K \E K' @ A \) then \( \G \AVS K' \E K @ A \).
        \item If \( \G \AVS \tau \E \tau' @ A \) then \( \G \AVS \tau' \E \tau @ A \).
        \item If \( \G \AVS M \E M' @ A \) then \( \G \AVS M' \E M @ A \).
    \end{itemize}
\end{lemma}

\begin{proof}
    It is obvious because all algorithmic equivalence rules are symmetrical.
\end{proof}

\begin{lemma}[Reflexivity in Algorithmic Equivalence]
    The algorithmic equivalence relationship is reflexive.
    \label{lemma:ReflexivityinAlgorithmicEquivalence}
    \begin{itemize}
        \item If \( \G \AVS K \E K @ A \) then \( \G \AVS K \E K @ A \).
        \item If \( \G \AVS \tau \E \tau @ A \) then \( \G \AVS \tau \E \tau @ A \).
        \item If \( \G \AVS M \E M @ A \) then \( \G \AVS M \E M @ A \).
    \end{itemize}
\end{lemma}

\begin{proof}
    Prove by induction.
\end{proof}

\begin{lemma}[Transition in Algorithmic Equivalence]
    The algorithmic equivalence relationship is transitive.
    \label{lemma:TransitioninAlgorithmicEquivalence}
    \begin{itemize}
        \item If \( \G \AVS K \E K' @ A \) and \( \G \AVS K' \E K'' @ A \) then \( \G \AVS K \E K'' @ A \).
        \item If \( \G \AVS \tau \E \tau' @ A \) and \( \G \AVS \tau' \E \tau'' @ A \) then \( \G \AVS \tau \E \tau'' @ A \).
        \item If \( \G \AVS M \E M' @ A \) and \( \G \AVS M' \E M'' @ A \) then \( \G \AVS M \E M'' @ A \).
    \end{itemize}
\end{lemma}

\begin{proof}
    Prove by the induction on derivations.  In this lemma, there are two
    hypothesis \( \mathcal{J}_1 \) and \( \mathcal{J}_2 \).  The last rules of
    \( \mathcal{J}_1 \) and \( \mathcal{J}_2 \) are the same.  Because these
    are algorithmic derivation so the last rule of derivation is decided
    uniquely by the shape of judgments.  Then we can prove this theorem easily
    from the induction hypothesis and the last rule.
\end{proof}

This lemma is used in \QPercent case in the proof of the completeness.

\begin{lemma}[Free Variable and Stage]
    \label{lemma:FreeVariableandStage}
    If \( \G\V M:\tau@{A\alpha} \) and \( \G\V M:\tau @A \) then \( \FV(M) = \emptyset \).
\end{lemma}

\begin{proof}
    Prove by contradiction. Assume \( \G\V M:\tau@{A\alpha} \) and \({ \G\V
    M:\tau @A }\) and \( \FV(M) \neq \emptyset \). Then, \( x : \tau @ B, x:
    \tau @ B\alpha \in \G \). However, from well-formedness of \( \G \), there
    is no such \( x \).
\end{proof}

This is the last theorem -- Completeness. It means that when a term is typed in
the original typing, it is also typed in the algorithmic typing.

\begin{theorem}[Completeness of Algorithmic Typing]\
    \label{theorem:CompletenessofAlgorithmicTyping}
    \begin{itemize}
        \item If \(\G\V K \) then \(\G\AVS K \).
        \item If \(\G\V \tau ::K @ A \) then there is \(K'\) such that \( \G \AVS K' @ A \) and \({ \G \AVS K\E K' @ A }\) and \({ \G\AVS \tau :: K' @ A }\).
        \item If \(\G\V M:\tau @ A \) then there is \(\tau'\) such that \({ \G \AVS \tau' :: * @ A }\) and \({ \G \AVS \tau \E \tau' @ A }\) and \({ \G\AVS M:\tau' @ A }\).
        \item If \(\G\V K\E K' @ A \) then \(\G\AVS K\E K' @ A \).
        \item If \(\G\V \tau \E \tau' :: K @ A \) then \(\G\AVS \tau \E \tau' @ A \).
        \item If \(\G\V M\E M' : \tau @ A \) then \(\G \AVS M \E M' @ A \).
    \end{itemize}
\end{theorem}

\begin{proof}
    Prove by induction on the derivation.
    \begin{rneqncase}{\KApp}{
            \G\V \sigma\ M::K[x\mapsto M]@A \\
            \text{ is derived from } 
            \G\V \sigma:: (\Pi x:\tau.K)@A \text{ and } \G\V M:\tau@A.
        }
        Apply the induction hypothesis on \( \G\V \sigma:: (\Pi x:\tau.K)@A \),
        there is a kind \( J \) such that \( \G\AVS J @A \), \( \G\AVS \sigma
        :: J \) and \( \G\AVS J \E (\Pi x:\tau.K)@A \).  The last rule of the
        derivation of \( \G\AVS J \E (\Pi x:\tau.K)@A \) is \QTAAbs, so \( J =
        \Pi x:\tau'.K' \), \( \G \AVS \tau \E \tau' @ A \) and \( \G, x:\tau
        \AVS K \E K' @ A \).  Use Lemma \ref{lemma:Agreement} and the induction
        hypothesis on \( \G \V M : \tau @ A \), \( \G \AVS \tau :: * @ A \).
        Now, we can apply \KAApp to \( \G \AVS \sigma :: \Pi x:\tau'.K' @ A \),
        \( \G \AVS M: \tau @ A \) and \( \G \AVS \tau \E \tau' @ A\) and get \(
        \G \AVS \sigma\ M :: K'[x \mapsto M] @ A \).  From Lemma
        \ref{lemma:TermSubstitutionLemmaOfAlgorithmicJudgement}, \( \G \AVS K[x
        \mapsto M] \E K'[x \mapsto M] @ A \).
    \end{rneqncase}
    \begin{rneqncase}{\KConv}{
            \G\V \tau::J@A \\
            \text{ is derived from }
            \G\V \tau::K@A \text{ and }
            \G\V K\equiv J@A
        }
        Apply the induction hypothesis on \( \G\V \tau::K@A \),
        there is a kind K' such that \( \G \AVS K' @ A \) and 
        \( \G \AVS K\E K' @ A \) and \( \G\AVS \tau :: K' @ A \).
        Apply the induction hypothesis on \( \G\V K\equiv J@A \),
        \( \G\AVS K\equiv J@A \).
        From Lemma \ref{lemma:SymmetricityinAlgorithmicEquivalence} and
        \ref {lemma:TransitioninAlgorithmicEquivalence}, \( \G \AVS J \E K' @ A \).
    \end{rneqncase}
    \begin{rneqncase}{\QTApp}{
            \G\V \tau\ M \E \sigma\ N :: K[x \mapsto M]@A \\
            \text{ is derived from }
            \G\V \tau \E \sigma :: (\Pi x:\rho.K)@A \text{ and } \\
            \G\V M \E N : \rho @A
        }
        From the induction hypothesis, \( \G\AVS \tau \E \sigma@A \) and \(
        \G\AVS M \E N @A \). Use \TAApp, \( \G\AVS \tau\ M \E \sigma\ N \).
    \end{rneqncase}
    \begin{rneqncase}{\TConv}{
            \G\V M:\tau'@A \\
            \text{ is derived from }
            \G\V M:\tau@A \text{ and }
            \G\V \tau\equiv \tau':: K@A
        }
        Apply the induction hypothesis on \( \G\V \tau\equiv \tau':: K@A \), \(
        \G\AVS \tau\equiv \tau' @A \).  Use Lemma \ref{lemma:Agreement} and the
        induction hypothesis to \( \G\V M : \tau @A \), we get \( \G\AVS \tau
        :: * @ A \). Now we can see \( \tau \) as \( \tau' \) in the second
        item of Theorem \ref{theorem:CompletenessofAlgorithmicTyping}.
    \end{rneqncase}
    \begin{rneqncase}{\QPercent}{
            \G\V\%_\alpha M \E M : \tau@{A\alpha}
            \text{ is derived from } \\
            \G\V M:\tau@{A\alpha} \text{ and }
            \G\V M:\tau@A
        }
        From Lemma \ref{lemma:FreeVariableandStage}, \( \FV(M) = \emptyset \). Then, \( \%_\alpha M \RA M \) and \( \ANF(\%_\alpha M) = \ANF(M) \). So, \( \G\AVS\%_\alpha M \E M \) by \QAANF.
    \end{rneqncase}
    \begin{rneqncase}{\QKSym}{}
        It is obvious from Lemma \ref{lemma:SymmetricityinAlgorithmicEquivalence}.
    \end{rneqncase}
    \begin{rneqncase}{\QKRefl}{}
        It is obvious from Lemma \ref{lemma:ReflexivityinAlgorithmicEquivalence}.
    \end{rneqncase}
    \begin{rneqncase}{\QKTrans}{}
        It is obvious from Lemma \ref{lemma:TransitioninAlgorithmicEquivalence}.
    \end{rneqncase}
\end{proof}

From Theorem \ref{theorem:SoundnessOfAlgorithmicTyping} and
\ref{theorem:CompletenessofAlgorithmicTyping}, we can say the original typing
and the algorithmic typing are equivalent.
